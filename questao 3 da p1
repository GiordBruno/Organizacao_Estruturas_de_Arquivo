#include <stdio.h>
#include <string.h>
#include <stdlib.h>
FILE *f1, *f2, *saida;
typedef struct _Registro registro;
struct _Registro
{
	char chave[8];
	char nome[40];
	char email[40];
	char telefone[12];
	char rabiene[1];
};
registro reg1;
registro reg2;
long posicao, primeiro, ultimo2, meio;
int buscabinaria();

int main (int argc, char ** argv)
{
    int ultimo1=0,i;
	f1 = fopen ("familiahomens.dat","r");
    f2 = fopen ("familiamulheres.dat","r");
    saida = fopen("arq3.dat","w");

	fseek(f1,0,SEEK_END);
	ultimo1 = (ftell(f1)/sizeof(registro));
	
	fseek(f2,0,SEEK_END);
	ultimo2 = (ftell(f2)/sizeof(registro));
	
	primeiro = 0;
   	meio = (primeiro+ultimo2)/2;
   	
	printf("ultimo %d\n",ultimo1);
	printf("ultimo1 %d\n",ultimo2);
	printf("Tamanho do Arquivo f1: %ld\n", ftell(f1));
	printf("Tamanho do Registro f1: %ld\n", sizeof(registro));
	printf("Tamanho do Arquivo em Registros: %ld\n\n", ultimo1);
	rewind(f1);
	rewind(f2);
	for(i=0;i<ultimo1;i++){
		fseek(f1,i*sizeof(registro),SEEK_SET);
		printf("Posicao para leitura: %d\n",ftell(f1));
		fread(&reg1,sizeof(registro),1,f1);
		printf("Registro %.8s\n",reg1.chave);
	}
	printf("\n\n\n\n\n");
	printf("Tamanho do Arquivo f1: %ld\n", ftell(f2));
	printf("Tamanho do Registro f1: %ld\n", sizeof(registro));
	printf("Tamanho do Arquivo em Registros: %ld\n\n", ultimo2);
	
	for(i=0;i<ultimo2;i++){
		fseek(f2,i*sizeof(registro),SEEK_SET);
		printf("Posicao para leitura: %d\n",ftell(f2));
		fread(&reg2,sizeof(registro),1,f2);
		printf("Registro %.8s\n",reg2.chave);
	}
	for(i=0;i<ultimo1;i++){
		fseek(f1,i*sizeof(registro),SEEK_SET);
		fread(&reg1,sizeof(registro),1,f1);
		if(buscabinaria())
			fwrite(&reg1,sizeof(registro),1,saida);	
	}
	fclose(f1);
	fclose(f2);
	fclose(saida);
	
}
int sametime(){
	
		
	}
int buscabinaria(){
	
	
	ultimo2=(ftell(f2)/(sizeof(registro)))-1;
	primeiro=0;
	while(primeiro<=ultimo2){
		meio = (primeiro+ultimo2)/2;
		fseek(f2,meio*sizeof(registro),SEEK_SET);
		fread(&reg2,sizeof(registro),1,f2);
		
		if(strncmp(reg1.chave,reg2.chave,8))
			return 1;
		else if(strncmp(reg1.chave,reg2.chave,8)<0)
				primeiro = meio+1;	
		else{ if(strncmp(reg1.chave,reg2.chave,8)>0)
				ultimo2 = meio-1;
		}
		
	}
	return 0;
}
